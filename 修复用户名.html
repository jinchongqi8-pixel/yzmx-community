<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¿®å¤å¸–å­ç”¨æˆ·å</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    .info {
      background: #e0f2fe;
      color: #075985;
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      border-left: 4px solid #0ea5e9;
    }
    .success {
      background: #d1fae5;
      color: #065f46;
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      border-left: 4px solid #10b981;
    }
    .warning {
      background: #fff3cd;
      color: #856404;
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      border-left: 4px solid #ffc107;
    }
    .btn {
      padding: 12px 24px;
      background: #0ea5e9;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 12px;
    }
    .btn:hover { background: #0284c7; }
    .btn-danger { background: #ef4444; }
    .btn-danger:hover { background: #dc2626; }
    textarea {
      width: 100%;
      min-height: 150px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      box-sizing: border-box;
      margin: 16px 0;
    }
    .stat {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
    }
    .stat-item {
      text-align: center;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      flex: 1;
      margin: 0 8px;
    }
    .stat-number {
      font-size: 32px;
      font-weight: 700;
      color: #0ea5e9;
    }
    .stat-label {
      font-size: 14px;
      color: #666;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ å¸–å­ç”¨æˆ·åä¿®å¤å·¥å…·</h1>

    <div class="info">
      <strong>â„¹ï¸ åŠŸèƒ½è¯´æ˜ï¼š</strong><br>
      è¿™ä¸ªå·¥å…·ä¼šè‡ªåŠ¨ä¿®å¤å¸–å­ä¸­çš„ç”¨æˆ·åæ˜¾ç¤ºé—®é¢˜ã€‚<br>
      å®ƒä¼šä» users æ•°ç»„ä¸­è·å–æœ€æ–°æ˜µç§°ï¼Œå¹¶æ›´æ–°æ‰€æœ‰å¸–å­çš„ userName å­—æ®µã€‚
    </div>

    <div class="stat">
      <div class="stat-item">
        <div class="stat-number" id="totalPosts">0</div>
        <div class="stat-label">å¸–å­æ€»æ•°</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="fixedPosts">0</div>
        <div class="stat-label">éœ€è¦ä¿®å¤</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="userCount">0</div>
        <div class="stat-label">ç”¨æˆ·æ€»æ•°</div>
      </div>
    </div>

    <button class="btn" onclick="analyzeData()">ğŸ“Š åˆ†ææ•°æ®</button>
    <button class="btn" onclick="fixUserNames()">ğŸ”§ ä¿®å¤ç”¨æˆ·å</button>
    <button class="btn btn-danger" onclick="if(confirm('ç¡®å®šè¦æ¸…ç©ºæ•°æ®é‡æ–°å¼€å§‹å—ï¼Ÿ')){localStorage.clear();location.reload();}">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>

    <div id="result"></div>
  </div>

  <script>
    function showStats() {
      const posts = JSON.parse(localStorage.getItem('posts') || '[]');
      const users = JSON.parse(localStorage.getItem('users') || '[]');

      document.getElementById('totalPosts').textContent = posts.length;
      document.getElementById('userCount').textContent = users.length;

      // åˆ†æéœ€è¦ä¿®å¤çš„å¸–å­
      let fixedCount = 0;
      posts.forEach(post => {
        const user = users.find(u => u._id === post.userId || u.phone === post.userId?.replace('user_', ''));
        if (user && user.nickname !== post.userName) {
          fixedCount++;
        }
      });

      document.getElementById('fixedPosts').textContent = fixedCount;
    }

    function analyzeData() {
      const posts = JSON.parse(localStorage.getItem('posts') || '[]');
      const users = JSON.parse(localStorage.getItem('users') || '[]');

      let html = '<div class="info"><strong>ğŸ“Š æ•°æ®åˆ†ææŠ¥å‘Šï¼š</strong><br><br>';
      html += `å¸–å­æ€»æ•°ï¼š${posts.length}<br>`;
      html += `ç”¨æˆ·æ€»æ•°ï¼š${users.length}<br><br>`;

      let problems = [];
      posts.forEach(post => {
        const user = users.find(u => u._id === post.userId);
        if (!user) {
          problems.push(`âŒ å¸–å­ "${post.content.substring(0, 30)}..." çš„ä½œè€… ${post.userId} ä¸åœ¨ç”¨æˆ·åˆ—è¡¨ä¸­`);
        } else if (user.nickname !== post.userName) {
          problems.push(`âš ï¸ å¸–å­ "${post.content.substring(0, 30)}..." çš„ç”¨æˆ·åï¼š${post.userName} â†’ åº”è¯¥æ˜¯ï¼š${user.nickname}`);
        }
      });

      if (problems.length === 0) {
        html += 'âœ… æ‰€æœ‰æ•°æ®æ­£å¸¸ï¼</div>';
      } else {
        html += `<strong>å‘ç° ${problems.length} ä¸ªé—®é¢˜ï¼š</strong><br><br>`;
        problems.slice(0, 10).forEach(p => {
          html += p + '<br>';
        });
        if (problems.length > 10) {
          html += `<br>...è¿˜æœ‰ ${problems.length - 10} ä¸ªé—®é¢˜`;
        }
        html += '</div>';
      }

      document.getElementById('result').innerHTML = html;
      showStats();
    }

    function fixUserNames() {
      const posts = JSON.parse(localStorage.getItem('posts') || '[]');
      const users = JSON.parse(localStorage.getItem('users') || '[]');

      let fixedCount = 0;
      const problems = [];

      posts.forEach(post => {
        // æ–¹æ³•1: é€šè¿‡ userId åŒ¹é…
        let user = users.find(u => u._id === post.userId);

        // æ–¹æ³•2: å¦‚æœæ‰¾ä¸åˆ°ï¼Œå°è¯•é€šè¿‡æ‰‹æœºå·åŒ¹é…
        if (!user && post.userId && post.userId.startsWith('user_')) {
          const phone = post.userId.replace('user_', '');
          user = users.find(u => u.phone === phone);
        }

        if (user) {
          if (user.nickname !== post.userName) {
            const oldName = post.userName;
            post.userName = user.nickname;
            fixedCount++;
            problems.push(`âœ… "${oldName}" â†’ "${user.nickname}"`);
          }
        } else {
          problems.push(`âŒ æ‰¾ä¸åˆ°ç”¨æˆ· ${post.userId}`);
        }
      });

      localStorage.setItem('posts', JSON.stringify(posts));

      let html = '<div class="success"><strong>âœ… ä¿®å¤å®Œæˆï¼</strong><br><br>';
      html += `ä¿®å¤äº† ${fixedCount} ä¸ªç”¨æˆ·å<br><br>`;
      if (problems.length > 0 && problems.length < 20) {
        html += '<strong>è¯¦ç»†è®°å½•ï¼š</strong><br>';
        problems.forEach(p => {
          html += p + '<br>';
        });
      }
      html += '</div>';

      document.getElementById('result').innerHTML = html;
      showStats();
    }

    window.onload = function() {
      showStats();
    };
  </script>
</body>
</html>
