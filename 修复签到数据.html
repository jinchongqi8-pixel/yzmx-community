<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¿®å¤ç­¾åˆ°æ•°æ®</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    .info {
      background: #e0f2fe;
      color: #075985;
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      border-left: 4px solid #0ea5e9;
    }
    .warning {
      background: #fff3cd;
      color: #856404;
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      border-left: 4px solid #ffc107;
    }
    .success {
      background: #d1fae5;
      color: #065f46;
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      border-left: 4px solid #10b981;
    }
    .btn {
      padding: 12px 24px;
      background: #0ea5e9;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 12px;
    }
    .btn:hover { background: #0284c7; }
    .user-card {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
      margin: 12px 0;
    }
    .user-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    .user-detail {
      font-size: 14px;
      color: #666;
      margin: 4px 0;
    }
    .diff {
      color: #dc2626;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ ç­¾åˆ°æ•°æ®ä¿®å¤å·¥å…·</h1>

    <div class="info">
      <strong>ğŸ’¡ åŠŸèƒ½è¯´æ˜ï¼š</strong><br>
      è¿™ä¸ªå·¥å…·ä¼šæ£€æŸ¥å¹¶ä¿®å¤ç”¨æˆ·æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚<br>
      ä»¥é‡‘å¸æ•°é‡è¾ƒå¤šçš„æ•°æ®ä¸ºå‡†è¿›è¡ŒåŒæ­¥ã€‚
    </div>

    <button class="btn" onclick="checkData()">ğŸ“Š æ£€æŸ¥æ•°æ®</button>
    <button class="btn" onclick="syncData()">ğŸ”„ åŒæ­¥æ•°æ®</button>

    <div id="result"></div>
  </div>

  <script>
    function checkData() {
      const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const checkins = JSON.parse(localStorage.getItem('checkins') || '{}');

      let html = '<div class="info"><strong>ğŸ“Š æ•°æ®æ£€æŸ¥æŠ¥å‘Šï¼š</strong><br><br>';

      // å½“å‰ç”¨æˆ·ä¿¡æ¯
      html += `<div class="user-card">`;
      html += `<div class="user-title">ğŸ‘¤ å½“å‰ç™»å½•ç”¨æˆ· (userInfo)</div>`;
      html += `<div class="user-detail">ID: ${userInfo._id || 'æ— '}</div>`;
      html += `<div class="user-detail">æ˜µç§°: ${userInfo.nickname || 'æ— '}</div>`;
      html += `<div class="user-detail">é‡‘å¸: <strong>${userInfo.coins || 0}</strong></div>`;
      html += `<div class="user-detail">ç­¾åˆ°å¤©æ•°: ${userInfo.checkInDays || 0}</div>`;
      html += `</div>`;

      // users æ•°ç»„ä¸­çš„ç”¨æˆ·
      const userInArray = users.find(u => u._id === userInfo._id);
      if (userInArray) {
        html += `<div class="user-card">`;
        html += `<div class="user-title">ğŸ‘¥ users æ•°ç»„ä¸­çš„ç”¨æˆ·</div>`;
        html += `<div class="user-detail">ID: ${userInArray._id}</div>`;
        html += `<div class="user-detail">æ˜µç§°: ${userInArray.nickname || 'æ— '}</div>`;
        html += `<div class="user-detail">é‡‘å¸: <strong>${userInArray.coins || 0}</strong></div>`;
        html += `<div class="user-detail">ç­¾åˆ°å¤©æ•°: ${userInArray.checkInDays || 0}</div>`;

        // æ¯”è¾ƒå·®å¼‚
        const coinDiff = (userInfo.coins || 0) - (userInArray.coins || 0);
        if (coinDiff !== 0) {
          html += `<div class="user-detail diff">é‡‘å¸å·®å¼‚: ${coinDiff > 0 ? '+' : ''}${coinDiff}</div>`;
        }
        html += `</div>`;
      } else {
        html += `<div class="warning">âš ï¸ users æ•°ç»„ä¸­æ‰¾ä¸åˆ°æ­¤ç”¨æˆ·ï¼</div>`;
      }

      // ç­¾åˆ°è®°å½•
      const userCheckins = checkins[userInfo._id] || [];
      html += `<div class="user-card">`;
      html += `<div class="user-title">ğŸ“… ç­¾åˆ°è®°å½•</div>`;
      html += `<div class="user-detail">æ€»ç­¾åˆ°æ¬¡æ•°: ${userCheckins.length}</div>`;
      if (userCheckins.length > 0) {
        html += `<div class="user-detail">æœ€è¿‘ç­¾åˆ°: ${userCheckins[0].date}</div>`;
      }
      html += `</div>`;

      html += '</div>';
      document.getElementById('result').innerHTML = html;
    }

    function syncData() {
      const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
      if (!userInfo._id) {
        alert('âŒ è¯·å…ˆç™»å½•ï¼');
        return;
      }

      const users = JSON.parse(localStorage.getItem('users') || '[]');
      const userIndex = users.findIndex(u => u._id === userInfo._id);

      let fixedCount = 0;
      let html = '<div class="success"><strong>âœ… åŒæ­¥å®Œæˆï¼</strong><br><br>';

      if (userIndex !== -1) {
        // æ‰¾åˆ°äº†ï¼Œæ¯”è¾ƒå¹¶åŒæ­¥ï¼ˆä»¥é‡‘å¸å¤šçš„ä¸ºå‡†ï¼‰
        const userInArray = users[userIndex];
        const userInfoCoins = userInfo.coins || 0;
        const userArrayCoins = userInArray.coins || 0;

        if (userInfoCoins !== userArrayCoins) {
          const maxCoins = Math.max(userInfoCoins, userArrayCoins);
          userInfo.coins = maxCoins;
          users[userIndex].coins = maxCoins;
          html += `é‡‘å¸å·²åŒæ­¥ä¸º: ${maxCoins}<br>`;
          fixedCount++;
        }

        // åŒæ­¥ç­¾åˆ°å¤©æ•°ï¼ˆä»¥å¤§çš„ä¸ºå‡†ï¼‰
        const userInfoDays = userInfo.checkInDays || 0;
        const userArrayDays = userInArray.checkInDays || 0;
        if (userInfoDays !== userArrayDays) {
          const maxDays = Math.max(userInfoDays, userArrayDays);
          userInfo.checkInDays = maxDays;
          users[userIndex].checkInDays = maxDays;
          html += `ç­¾åˆ°å¤©æ•°å·²åŒæ­¥ä¸º: ${maxDays}<br>`;
          fixedCount++;
        }

        // åŒæ­¥å…¶ä»–å­—æ®µ
        if (userInfo.nickname && !userInArray.nickname) {
          users[userIndex].nickname = userInfo.nickname;
          html += `æ˜µç§°å·²åŒæ­¥<br>`;
          fixedCount++;
        }
        if (userInfo.avatar && !userInArray.avatar) {
          users[userIndex].avatar = userInfo.avatar;
          html += `å¤´åƒå·²åŒæ­¥<br>`;
          fixedCount++;
        }
      } else {
        // æ²¡æ‰¾åˆ°ï¼Œæ·»åŠ åˆ° users æ•°ç»„
        users.push(userInfo);
        html += `âœ… ç”¨æˆ·å·²æ·»åŠ åˆ° users æ•°ç»„<br>`;
        fixedCount++;
      }

      // ä¿å­˜
      localStorage.setItem('userInfo', JSON.stringify(userInfo));
      localStorage.setItem('users', JSON.stringify(users));

      if (fixedCount === 0) {
        html += 'âœ… æ•°æ®å·²ç»æ˜¯åŒæ­¥çš„ï¼Œæ— éœ€ä¿®å¤';
      }

      html += '</div>';
      document.getElementById('result').innerHTML = html;
    }
  </script>
</body>
</html>
