<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ£€æŸ¥å¸–å­æ•°æ®</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    h2 { color: #0ea5e9; margin-top: 0; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
    }
    .btn {
      padding: 8px 16px;
      background: #0ea5e9;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    .btn:hover { background: #0284c7; }
    .btn-danger { background: #ef4444; }
    .btn-danger:hover { background: #dc2626; }
    .post-item {
      padding: 16px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    .post-content {
      margin: 8px 0;
      color: #333;
    }
    .post-meta {
      font-size: 12px;
      color: #999;
    }
    .warning {
      background: #fff3cd;
      color: #856404;
      padding: 12px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .success {
      background: #d1fae5;
      color: #065f46;
      padding: 12px;
      border-radius: 4px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>ğŸ” å¸–å­æ•°æ®æ£€æŸ¥å·¥å…·</h1>

  <div class="section">
    <h2>ğŸ“Š localStorage æ•°æ®æ¦‚è§ˆ</h2>
    <div id="storageOverview"></div>
  </div>

  <div class="section">
    <h2>ğŸ“ æ‰€æœ‰å¸–å­æ•°æ®</h2>
    <div id="postsData"></div>
    <button class="btn btn-danger" onclick="clearAllPosts()">æ¸…ç©ºæ‰€æœ‰å¸–å­</button>
    <button class="btn" onclick="location.reload()">åˆ·æ–°é¡µé¢</button>
  </div>

  <div class="section">
    <h2>ğŸ”§ æ•°æ®ä¿®å¤å·¥å…·</h2>
    <div class="warning">
      <strong>âš ï¸ æ³¨æ„ï¼š</strong>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¼šå°è¯•åˆå¹¶æ‰€æœ‰å¸–å­æ•°æ®ï¼Œç¡®ä¿æ²¡æœ‰ä¸¢å¤±
    </div>
    <button class="btn" onclick="mergePosts()">ğŸ”„ åˆå¹¶æ‰€æœ‰å¸–å­æ•°æ®</button>
    <button class="btn" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
  </div>

  <script>
    // æ˜¾ç¤ºæ‰€æœ‰ localStorage é”®
    function showStorageOverview() {
      const overview = document.getElementById('storageOverview');
      let html = '<table><thead><tr><th>é”®å</th><th>æ•°æ®ç±»å‹</th><th>æ•°æ®å¤§å°</th><th>è®°å½•æ•°</th></tr></thead><tbody>';

      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        const value = localStorage.getItem(key);
        let dataType = 'æœªçŸ¥';
        let recordCount = '-';

        try {
          const parsed = JSON.parse(value);
          if (Array.isArray(parsed)) {
            dataType = 'æ•°ç»„';
            recordCount = parsed.length;
          } else if (typeof parsed === 'object') {
            dataType = 'å¯¹è±¡';
            recordCount = Object.keys(parsed).length;
          } else {
            dataType = typeof parsed;
          }
        } catch (e) {
          dataType = 'å­—ç¬¦ä¸²';
        }

        const sizeInBytes = new Blob([value]).size;
        const sizeInKB = (sizeInBytes / 1024).toFixed(2);

        html += `<tr>
          <td><strong>${key}</strong></td>
          <td>${dataType}</td>
          <td>${sizeInKB} KB</td>
          <td>${recordCount}</td>
        </tr>`;
      }

      html += '</tbody></table>';
      overview.innerHTML = html;
    }

    // æ˜¾ç¤ºæ‰€æœ‰å¸–å­
    function showAllPosts() {
      const container = document.getElementById('postsData');
      const posts = JSON.parse(localStorage.getItem('posts') || '[]');

      if (posts.length === 0) {
        container.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">æš‚æ— å¸–å­æ•°æ®</p>';
        return;
      }

      let html = `<p class="success">âœ… å…±æ‰¾åˆ° ${posts.length} æ¡å¸–å­</p>`;

      posts.forEach((post, index) => {
        const date = new Date(post.createdAt || post.timestamp);
        const formattedDate = date.toLocaleString('zh-CN');

        html += `<div class="post-item">
          <div><strong>#${index + 1} - ${post.userName || 'åŒ¿å'}</strong></div>
          <div class="post-content">${post.content || 'ï¼ˆæ— å†…å®¹ï¼‰'}</div>
          <div class="post-meta">
            ğŸ†” ${post._id} |
            ğŸ“… ${formattedDate} |
            ğŸ‘ ${post.viewCount || 0} |
            â¤ï¸ ${post.likeCount || post.likes || 0} |
            ğŸ’¬ ${post.commentCount || 0}
            ${post.images && post.images.length ? ` | ğŸ–¼ï¸ ${post.images.length}å¼ å›¾ç‰‡` : ''}
          </div>
        </div>`;
      });

      container.innerHTML = html;
    }

    // æ¸…ç©ºæ‰€æœ‰å¸–å­
    function clearAllPosts() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å¸–å­å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        localStorage.removeItem('posts');
        alert('âœ… å·²æ¸…ç©ºæ‰€æœ‰å¸–å­');
        location.reload();
      }
    }

    // åˆå¹¶å¸–å­æ•°æ®ï¼ˆé˜²æ­¢æ•°æ®ä¸¢å¤±ï¼‰
    function mergePosts() {
      const currentPosts = JSON.parse(localStorage.getItem('posts') || '[]');
      const uniquePosts = [];
      const seenIds = new Set();

      // å»é‡
      currentPosts.forEach(post => {
        if (!seenIds.has(post._id)) {
          seenIds.add(post._id);
          uniquePosts.push(post);
        }
      });

      // æŒ‰æ—¶é—´æ’åº
      uniquePosts.sort((a, b) => {
        const timeA = new Date(a.createdAt || a.timestamp);
        const timeB = new Date(b.createdAt || b.timestamp);
        return timeB - timeA;
      });

      localStorage.setItem('posts', JSON.stringify(uniquePosts));

      alert(`âœ… å·²å®Œæˆæ•°æ®åˆå¹¶ï¼\n\nåŸå§‹å¸–å­æ•°ï¼š${currentPosts.length}\nå»é‡åï¼š${uniquePosts.length}`);
      location.reload();
    }

    // å¯¼å‡ºæ•°æ®
    function exportData() {
      const data = {
        posts: JSON.parse(localStorage.getItem('posts') || '[]'),
        users: JSON.parse(localStorage.getItem('users') || '[]'),
        userInfo: JSON.parse(localStorage.getItem('userInfo') || '{}'),
        timestamp: new Date().toISOString()
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `community-backup-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    window.onload = function() {
      showStorageOverview();
      showAllPosts();
    };
  </script>
</body>
</html>
