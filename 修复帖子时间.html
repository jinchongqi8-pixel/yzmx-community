<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¿®å¤å¸–å­æ—¶é—´</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    .info {
      background: #e0f2fe;
      color: #075985;
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      border-left: 4px solid #0ea5e9;
    }
    .success {
      background: #d1fae5;
      color: #065f46;
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      border-left: 4px solid #10b981;
    }
    .warning {
      background: #fff3cd;
      color: #856404;
      padding: 16px;
      border-radius: 8px;
      margin: 16px 0;
      border-left: 4px solid #ffc107;
    }
    .btn {
      padding: 12px 24px;
      background: #0ea5e9;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 12px;
    }
    .btn:hover { background: #0284c7; }
    .post-item {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
      font-size: 14px;
    }
    .post-time {
      color: #666;
      font-size: 12px;
      margin-top: 4px;
    }
    .missing {
      color: #dc2626;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ å¸–å­æ—¶é—´ä¿®å¤å·¥å…·</h1>

    <div class="info">
      <strong>ğŸ’¡ åŠŸèƒ½è¯´æ˜ï¼š</strong><br>
      è¿™ä¸ªå·¥å…·ä¼šæ£€æŸ¥æ‰€æœ‰å¸–å­çš„æ—¶é—´å­—æ®µï¼Œ<br>
      å¹¶è‡ªåŠ¨ä¿®å¤ç¼ºå¤±æˆ–é”™è¯¯çš„æ—¶é—´æˆ³ã€‚
    </div>

    <button class="btn" onclick="checkTimes()">ğŸ“Š æ£€æŸ¥å¸–å­æ—¶é—´</button>
    <button class="btn" onclick="fixTimes()">ğŸ”§ ä¿®å¤æ—¶é—´</button>

    <div id="result"></div>
  </div>

  <script>
    function checkTimes() {
      const posts = JSON.parse(localStorage.getItem('posts') || '[]');

      let html = '<div class="info"><strong>ğŸ“Š å¸–å­æ—¶é—´æ£€æŸ¥æŠ¥å‘Šï¼š</strong><br><br>';
      html += `æ€»å¸–å­æ•°ï¼š${posts.length}<br><br>`;

      let missingCount = 0;
      let invalidCount = 0;
      const problemPosts = [];

      posts.forEach((post, index) => {
        const hasCreatedAt = !!post.createdAt;
        const hasTimestamp = !!post.timestamp;
        const createdAtValue = post.createdAt;
        const timestampValue = post.timestamp;

        if (!hasCreatedAt && !hasTimestamp) {
          missingCount++;
          problemPosts.push({
            index: index + 1,
            content: post.content?.substring(0, 50) + '...',
            issue: 'å®Œå…¨ç¼ºå°‘æ—¶é—´å­—æ®µ'
          });
        } else if (!hasCreatedAt) {
          invalidCount++;
          problemPosts.push({
            index: index + 1,
            content: post.content?.substring(0, 50) + '...',
            issue: 'ç¼ºå°‘ createdAt'
          });
        }
      });

      html += `ç¼ºå°‘æ—¶é—´å­—æ®µï¼š${missingCount}<br>`;
      html += `ç¼ºå°‘ createdAtï¼š${invalidCount}<br>`;

      if (problemPosts.length > 0) {
        html += `<br><strong>é—®é¢˜å¸–å­ï¼ˆå‰10æ¡ï¼‰ï¼š</strong><br>`;
        problemPosts.slice(0, 10).forEach(p => {
          html += `<div class="post-item">`;
          html += `<div>#${p.index}: ${p.content}</div>`;
          html += `<div class="post-time missing">âš ï¸ ${p.issue}</div>`;
          html += `</div>`;
        });
      }

      if (missingCount === 0 && invalidCount === 0) {
        html += `<br>âœ… æ‰€æœ‰å¸–å­æ—¶é—´æ­£å¸¸ï¼`;
      }

      html += '</div>';
      document.getElementById('result').innerHTML = html;
    }

    function fixTimes() {
      const posts = JSON.parse(localStorage.getItem('posts') || '[]');

      let fixedCount = 0;
      const now = Date.now();
      const details = [];

      posts.forEach((post, index) => {
        const originalCreatedAt = post.createdAt;
        const originalTimestamp = post.timestamp;

        // å¦‚æœ createdAt ä¸ºç©ºã€æ— æ•ˆæˆ–ä¸æ˜¯æ•°å­—
        if (!post.createdAt || post.createdAt === 'åˆšåˆš' || isNaN(new Date(post.createdAt).getTime())) {
          let newTime = null;

          // æ–¹æ³•1: å°è¯•ä½¿ç”¨ timestamp
          if (post.timestamp && !isNaN(new Date(post.timestamp).getTime())) {
            newTime = post.timestamp;
            details.push(`å¸–å­${index + 1}: ä½¿ç”¨ timestamp (${post.timestamp})`);
          }
          // æ–¹æ³•2: å°è¯•ä» ID æå–æ—¶é—´æˆ³
          else {
            const idTime = parseInt(post._id);
            if (!isNaN(idTime) && idTime > 1000000000000 && idTime < now) {
              newTime = idTime;
              details.push(`å¸–å­${index + 1}: ä» ID æå–æ—¶é—´ (${idTime})`);
            }
            // æ–¹æ³•3: æ ¹æ®å¸–å­é¡ºåºæ¨ç®—æ—¶é—´ï¼ˆæ¯ä¸ªå¸–å­é—´éš”1åˆ†é’Ÿï¼‰
            else {
              newTime = now - (index * 60000);
              details.push(`å¸–å­${index + 1}: æ¨ç®—æ—¶é—´ (ç°åœ¨ - ${index}åˆ†é’Ÿ)`);
            }
          }

          post.createdAt = newTime;
          post.timestamp = newTime;
          fixedCount++;
        } else if (!post.timestamp) {
          // å¦‚æœ createdAt æ­£å¸¸ä½†æ²¡æœ‰ timestampï¼Œè¡¥å…… timestamp
          post.timestamp = post.createdAt;
        }
      });

      // æŒ‰æ—¶é—´å€’åºæ’åº
      posts.sort((a, b) => {
        const timeA = new Date(a.createdAt || a.timestamp || 0);
        const timeB = new Date(b.createdAt || b.timestamp || 0);
        return timeB - timeA;
      });

      localStorage.setItem('posts', JSON.stringify(posts));

      let html = '<div class="success"><strong>âœ… ä¿®å¤å®Œæˆï¼</strong><br><br>';
      html += `æ€»å…±æ£€æŸ¥äº† ${posts.length} ä¸ªå¸–å­<br>`;
      html += `ä¿®å¤äº† ${fixedCount} ä¸ªå¸–å­çš„æ—¶é—´<br><br>`;

      if (details.length > 0) {
        html += '<strong>ä¿®å¤è¯¦æƒ…ï¼š</strong><br>';
        details.slice(0, 10).forEach(d => {
          html += `â€¢ ${d}<br>`;
        });
      }

      html += `<br>è¯·åˆ·æ–°é¡µé¢æŸ¥çœ‹æ•ˆæœ`;
      html += '</div>';

      document.getElementById('result').innerHTML = html;
    }
  </script>
</body>
</html>
