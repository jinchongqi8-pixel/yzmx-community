# 阿里云短信服务配置指南

## 📱 第一步：注册阿里云并开通短信服务

### 1. 注册阿里云账号
访问：https://www.aliyun.com/
- 点击"免费注册"
- 完成实名认证（需要身份证）

### 2. 开通短信服务
1. 登录阿里云控制台
2. 搜索"短信服务"或访问：https://dysms.console.aliyun.com/
3. 点击"立即开通"
4. 选择"按量付费"或"套餐包"
   - 按量付费：每条短信 0.045 元
   - 套餐包：更便宜，适合大量发送

---

## 🔧 第二步：申请短信签名和模板

### 1. 申请签名
签名是短信开头的内容，如【学习社群】

**步骤：**
1. 进入短信服务控制台
2. 点击左侧"国内消息" → "签名管理"
3. 点击"添加签名"
4. 填写信息：
   - **签名名称**：学习社群
   - **签名来源**：个人测试或已备案网站
   - **签名用途**：用于用户登录验证

**注意事项：**
- 签名名称必须是已备案的网站或应用名称
- 个人开发者可以使用"自用"场景
- 审核时间：通常 1-2 小时

### 2. 申请短信模板
模板是短信的内容格式

**步骤：**
1. 点击左侧"国内消息" → "模板管理"
2. 点击"添加模板"
3. 填写信息：
   - **模板类型**：验证码
   - **模板名称**：登录验证码
   - **模板内容**：您的验证码是${code}，5分钟内有效。
   - **变量说明**：code:验证码

**重要提示：**
- 模板中必须使用 `${code}` 作为验证码变量
- 不要加其他文字，避免审核不通过
- 审核时间：通常 1-2 小时

---

## 🔑 第三步：获取 AccessKey

### 1. 创建 AccessKey
1. 点击右上角头像 → "AccessKey管理"
2. 点击"创建 AccessKey"
3. 建议使用"子用户AccessKey"（更安全）
4. 保存 AccessKeyID 和 AccessKeySecret

**⚠️ 重要：**
- AccessKeySecret 只显示一次，务必保存
- 建议下载 CSV 文件备份

---

## ⚙️ 第四步：配置云函数

打开文件：`cloudfunctions/login/index.js`

修改第 12-21 行的配置：

```javascript
const ALIYUN_SMS = {
  // 替换为你的阿里云 AccessKey
  accessKeyId: 'LTAI5tXXXXXXXXXXXXXXXX',  // 你的 AccessKeyId
  accessKeySecret: 'XXXXXXXXXXXXXXXXXXXXXXXX',  // 你的 AccessKeySecret

  // 短信签名（必须和申请的一致）
  signName: '学习社群',  // 如果申请了其他签名，替换这里

  // 短信模板代码（在阿里云控制台可以看到）
  templateCode: 'SMS_XXXXXXXXX'  // 你的模板代码
}
```

---

## 📊 第五步：创建数据库集合

在云开发控制台创建 `sms_codes` 集合：
- **集合名称**：sms_codes
- **权限设置**：所有用户可读，仅创建者可写

---

## 🚀 第六步：部署云函数

1. 右键 `cloudfunctions/login` 文件夹
2. 选择 **上传并部署：云端安装依赖**
3. 等待部署完成

---

## 🧪 第七步：测试功能

### 方法 1：在网页版测试
1. 运行 `npm run dev` 启动网页版
2. 打开登录页面
3. 输入手机号
4. 点击"获取验证码"
5. 查看是否收到短信

### 方法 2：在微信开发者工具测试
1. 打开小程序
2. 在控制台输入：
```javascript
wx.cloud.callFunction({
  name: 'login',
  data: {
    action: 'sendSmsCode',
    phone: '13800138000'  // 替换为你的手机号
  }
})
```

---

## 💰 费用说明

| 项目 | 价格 |
|------|------|
| 短信费用 | ¥0.045/条（国内短信） |
| 首次充值 | 最低 ¥100 |
| 免费额度 | 新用户可能赠送 100 条 |

**估算：**
- 100 次登录 × 1 条短信 = ¥4.5
- 1000 次登录 × 1 条短信 = ¥45

---

## ❓ 常见问题

### Q1: 签名审核不通过？
**A:**
- 尝试使用个人/测试场景
- 或使用已备案的网站名称
- 审核不通过会说明原因，按提示修改

### Q2: 模板审核不通过？
**A:**
- 确保模板格式正确
- 不要添加营销词汇
- 纯验证码模板容易通过

### Q3: 发送失败？
**A:**
- 检查 AccessKey 是否正确
- 检查余额是否充足
- 查看云函数日志

### Q4: 验证码收不到？
**A:**
- 检查手机号是否正确
- 查看云函数日志
- 确认短信签名和模板已通过审核

---

## 📞 技术支持

- 阿里云文档：https://help.aliyun.com/product/44282.html
- 短信服务API：https://help.aliyun.com/document_detail/101414.html

---

## ✅ 完成检查清单

- [ ] 注册阿里云并完成实名认证
- [ ] 开通短信服务
- [ ] 申请短信签名（【学习社群】）
- [ ] 申请短信模板（验证码${code}）
- [ ] 创建 AccessKey 并保存
- [ ] 修改云函数配置
- [ ] 创建 sms_codes 数据库集合
- [ ] 部署 login 云函数
- [ ] 测试发送验证码
