<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ£€æŸ¥å¸–å­è¯¦æƒ…</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { color: #333; }
    .post-card {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
      margin: 12px 0;
      border-left: 4px solid #ddd;
    }
    .post-card.problem {
      border-left-color: #ef4444;
      background: #fee2e2;
    }
    .post-card.ok {
      border-left-color: #10b981;
      background: #d1fae5;
    }
    .post-header {
      font-weight: 600;
      margin-bottom: 8px;
    }
    .post-detail {
      font-size: 13px;
      margin: 4px 0;
      font-family: monospace;
    }
    .label {
      color: #666;
    }
    .value {
      color: #333;
      font-weight: 600;
    }
    .btn {
      padding: 12px 24px;
      background: #0ea5e9;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 12px;
    }
    .btn:hover { background: #0284c7; }
    .btn-success {
      background: #10b981;
    }
    .btn-success:hover { background: #059669; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” å¸–å­æ•°æ®è¯¦æƒ…æ£€æŸ¥</h1>

    <button class="btn" onclick="showDetails()">ğŸ“Š æ˜¾ç¤ºè¯¦æƒ…</button>
    <button class="btn btn-success" onclick="fixAll()">ğŸ”§ ä¸€é”®ä¿®å¤å…¨éƒ¨</button>

    <div id="result"></div>
  </div>

  <script>
    function showDetails() {
      const posts = JSON.parse(localStorage.getItem('posts') || '[]');

      let html = `<strong>å…± ${posts.length} ä¸ªå¸–å­ï¼š</strong><br><br>`;

      posts.forEach((post, index) => {
        const hasProblem = !post.createdAt || post.createdAt === 'åˆšåˆš' || isNaN(new Date(post.createdAt).getTime());
        const cardClass = hasProblem ? 'post-card problem' : 'post-card ok';
        const status = hasProblem ? 'âŒ æœ‰é—®é¢˜' : 'âœ… æ­£å¸¸';

        html += `<div class="${cardClass}">`;
        html += `<div class="post-header">#${index + 1} ${status}</div>`;
        html += `<div class="post-detail"><span class="label">å¸–å­ID:</span> <span class="value">${post._id}</span></div>`;
        html += `<div class="post-detail"><span class="label">å†…å®¹:</span> <span class="value">${post.content?.substring(0, 40)}...</span></div>`;
        html += `<div class="post-detail"><span class="label">createdAt:</span> <span class="value">${post.createdAt}</span></div>`;
        html += `<div class="post-detail"><span class="label">createdAtç±»å‹:</span> <span class="value">${typeof post.createdAt}</span></div>`;
        html += `<div class="post-detail"><span class="label">timestamp:</span> <span class="value">${post.timestamp}</span></div>`;
        html += `<div class="post-detail"><span class="label">timestampç±»å‹:</span> <span class="value">${typeof post.timestamp}</span></div>`;

        if (hasProblem) {
          html += `<div class="post-detail" style="color:#dc2626;"><strong>âš ï¸ é—®é¢˜: ${!post.createdAt ? 'createdAtä¸ºç©º' : post.createdAt === 'åˆšåˆš' ? 'createdAtæ˜¯å­—ç¬¦ä¸²"åˆšåˆš"' : 'æ—¶é—´æ ¼å¼æ— æ•ˆ'}</strong></div>`;
        }

        html += `</div>`;
      });

      document.getElementById('result').innerHTML = html;
    }

    function fixAll() {
      const posts = JSON.parse(localStorage.getItem('posts') || '[]');
      const now = Date.now();
      let fixedCount = 0;
      const details = [];

      posts.forEach((post, index) => {
        const oldCreatedAt = post.createdAt;

        // æ£€æŸ¥å¹¶ä¿®å¤
        if (!post.createdAt || post.createdAt === 'åˆšåˆš' || typeof post.createdAt === 'string' || isNaN(new Date(post.createdAt).getTime())) {
          let newTime = null;

          // æ–¹æ³•1: ä½¿ç”¨ timestamp
          if (post.timestamp && typeof post.timestamp === 'number') {
            newTime = post.timestamp;
            details.push(`å¸–å­${index + 1}: ä½¿ç”¨ timestamp`);
          }
          // æ–¹æ³•2: ä» ID æå–
          else if (post._id && !isNaN(parseInt(post._id))) {
            const idNum = parseInt(post._id);
            if (idNum > 1000000000000 && idNum < now) {
              newTime = idNum;
              details.push(`å¸–å­${index + 1}: ä» ID æå– (${new Date(newTime).toLocaleString()})`);
            }
          }
          // æ–¹æ³•3: æ¨ç®—æ—¶é—´
          else {
            newTime = now - (index * 60000);
            details.push(`å¸–å­${index + 1}: æ¨ç®—æ—¶é—´`);
          }

          // è½¬æ¢ä¸ºæ•°å­—
          post.createdAt = newTime;
          post.timestamp = newTime;
          fixedCount++;
        } else {
          // ç¡®ä¿æ˜¯æ•°å­—ç±»å‹
          if (typeof post.createdAt === 'string') {
            post.createdAt = parseInt(post.createdAt);
            details.push(`å¸–å­${index + 1}: è½¬æ¢ä¸ºæ•°å­—`);
            fixedCount++;
          }
          if (!post.timestamp || typeof post.timestamp === 'string') {
            post.timestamp = post.createdAt;
          }
        }
      });

      // æ’åº
      posts.sort((a, b) => {
        const timeA = a.createdAt || a.timestamp || 0;
        const timeB = b.createdAt || b.timestamp || 0;
        return timeB - timeA;
      });

      localStorage.setItem('posts', JSON.stringify(posts));

      let html = `<div style="background: #d1fae5; padding: 16px; border-radius: 8px; color: #065f46;">`;
      html += `<strong>âœ… ä¿®å¤å®Œæˆï¼</strong><br><br>`;
      html += `ä¿®å¤äº† ${fixedCount} ä¸ªå¸–å­<br><br>`;
      if (details.length > 0) {
        html += `<strong>ä¿®å¤è¯¦æƒ…ï¼š</strong><br>`;
        details.forEach(d => html += `â€¢ ${d}<br>`);
      }
      html += `<br>è¯·åˆ·æ–°ç¤¾ç¾¤é¡µé¢æŸ¥çœ‹æ•ˆæœ`;
      html += `</div>`;

      document.getElementById('result').innerHTML = html;
    }
  </script>
</body>
</html>
